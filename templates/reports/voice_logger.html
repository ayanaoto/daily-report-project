<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Voice Logger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root{
      --fn-page-bg:#f8f9fa; --fn-text:#212529; --fn-header:#417690; --fn-accent:#79aec8;
      --fn-accent-2:#2a6078; --fn-accent-h:#195c77; --fn-input-bg:#fff; --fn-input-tx:#0b0f14;
      --fn-input-bd:#334155; --fn-input-ph:#6b7280; --fn-link:#1f4d66; --fn-link-h:#14394d;
    }
    body{ background:var(--fn-page-bg); color:var(--fn-text); }
    a{ color:var(--fn-link); text-decoration:none; } a:hover{ color:var(--fn-link-h); }
    .navbar{ background:var(--fn-header)!important; } .navbar .navbar-brand,.navbar .nav-link{ color:#eef7fb!important; }
    .navbar .nav-link:hover{ color:#fff!important; }
    .card{ background:#fff; border:1px solid #dee2e6; }
    .form-control{ background:#fff!important; color:#0b0f14!important; border:2px solid #334155!important; }
    .form-control:focus{ border-color:#0f3f5c!important; box-shadow:0 0 0 .2rem rgba(15,63,92,.2); }
    .btn-primary{ background:#2a6078!important; border-color:#2a6078!important; }
    .btn-primary:hover{ background:#195c77!important; border-color:#195c77!important; }
    .btn-success{ background:#2b6e3f!important; border-color:#2b6e3f!important; }
    .btn-success:hover{ background:#225a33!important; border-color:#225a33!important; }
    #tblDrafts{ table-layout:fixed; } #tblDrafts th,#tblDrafts td{ vertical-align:middle; }
    #tblDrafts thead th{ position:sticky; top:0; background:#2a6078!important; color:#fff!important; z-index:1; }
    #tblDrafts .col-id{ width:220px; } #tblDrafts .col-ts{ width:180px; white-space:nowrap; }
    #tblDrafts .col-ops{ width:180px; white-space:nowrap; } #tblDrafts .col-text{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    @media (max-width:768px){ #tblDrafts thead{ display:none; } #tblDrafts tr,#tblDrafts td{ display:block; width:100%!important; border:0!important; }
      #tblDrafts tr{ border-top:2px solid #2a6078; padding:.5rem 0; margin-bottom:1rem; }
      #tblDrafts .col-text,#tblDrafts .col-ts{ display:none; }
    }
    #btnSpeak.rec{ position:relative; }
    #btnSpeak.rec::after{ content:""; position:absolute; top:-6px; right:-6px; width:12px; height:12px; border-radius:9999px; background:#dc3545; box-shadow:0 0 0 6px rgba(220,53,69,.25); }
    /* 詳細モーダル */
    .vl-modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1050; display:flex; align-items:center; justify-content:center; padding:24px; }
    .vl-modal{ width:min(960px,96vw); max-height:min(80vh,900px); display:flex; flex-direction:column; background:#fff; color:#111827; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden; }
    .vl-modal-header{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #e5e7eb; background:#f8fafc; color:#0f172a; font-weight:600; }
    .vl-modal-title{ margin:0; font-size:16px; }
    .vl-btn-close{ appearance:none; border:0; background:transparent; cursor:pointer; width:28px; height:28px; border-radius:6px; color:#334155; }
    .vl-btn-close:hover{ background:#e2e8f0; }
    .vl-modal-body{ padding:16px; overflow:auto; }
    .vl-modal-body pre{ margin:0; white-space:pre-wrap; word-break:break-word; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:14px; line-height:1.6; color:#111827; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/reports/">FieldNote</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="/reports/">日報一覧</a></li>
          <li class="nav-item"><a class="nav-link" href="/reports/customers/">顧客</a></li>
          <li class="nav-item"><a class="nav-link" href="/reports/deals/">案件</a></li>
          <li class="nav-item"><a class="nav-link" href="/reports/troubleshooting/">トラブルシュート</a></li>
          <li class="nav-item"><a class="nav-link" href="/reports/todo/">ToDo</a></li>
          <li class="nav-item"><a class="nav-link" href="/reports/voice-logger/">音声ログ</a></li>
        </ul>
        <div class="d-flex align-items-center gap-2">
          <a class="btn btn-success" href="/reports/create/">＋日報</a>
          <div class="dropdown">
            <button class="btn btn-outline-light dropdown-toggle" data-bs-toggle="dropdown">pc</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="/reports/profile/">プロフィール</a></li>
              <li><a class="dropdown-item" href="/admin/">管理サイト</a></li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <form action="/accounts/logout/" method="post" class="px-2 py-1">
                  <button type="submit" class="btn btn-sm btn-outline-danger w-100">ログアウト</button>
                </form>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="container" style="max-width:980px">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="mb-0">Voice Logger</h1>
        <span class="badge text-bg-light" id="netStatus">ONLINE</span>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <label class="form-label" for="vl-textarea">メモ / 指示</label>
        <textarea id="vl-textarea" class="form-control" rows="4" placeholder="例）A社 10/3 15:00 訪問の件、資料は最新版v3で。"></textarea>
          <div class="d-flex align-items-center justify-content-between mt-2">
            <small class="text-secondary"><span id="charCount">0</span> 文字</small>
            <small class="text-secondary">長押し＝文字起こし（STT）</small>
          </div>
          <div class="mt-3 d-flex flex-wrap gap-2">
            <button id="btnSpeak" class="btn btn-primary">長押しでSTT（文字起こし）</button>
            <button id="btnSave" class="btn btn-success">保存（ログに追加）</button>
            <button id="btnClear" class="btn btn-outline-secondary">クリア</button>
          </div>
          <div class="mt-2 text-muted small">
            ※ 日報には各自でコピー＆ペーストしてください。
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <label class="form-label">再生</label>
          <audio id="player" controls preload="none" style="width:100%"></audio>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>ローカル下書き</span>
          <div class="d-flex flex-wrap gap-2">
            <button id="btnSync" class="btn btn-sm btn-outline-secondary">未送信を同期</button>
            <button id="btnPurge" class="btn btn-sm btn-outline-danger">全削除</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped mb-0" id="tblDrafts">
            <thead>
              <tr>
                <th class="col-id">ローカルID</th>
                <th class="col-text">テキスト</th>
                <th class="col-ts">日時</th>
                <th class="col-ops">操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- （必要なら）サーバで data-token を埋める。開発は devtoken -->
    <div id="__cfg" data-token="devtoken" hidden></div>

    <script>
      (() => {
        "use strict";

        const alertMsg = (m) => window.alert(m);
        const fmtJST = new Intl.DateTimeFormat("ja-JP",{dateStyle:"medium",timeStyle:"medium",timeZone:"Asia/Tokyo"});
        const LS_DRAFTS="vl_drafts";

        const cfgEl = document.getElementById("__cfg");
        const qs = new URLSearchParams(location.search);
        const tokenFromQS  = qs.get("token");
        const tokenFromLS  = localStorage.getItem("FN_API_TOKEN");
        const tokenFromDOM = cfgEl?.dataset?.token;
        const API_TOKEN = (tokenFromQS || tokenFromLS || tokenFromDOM || "").trim();
        if (tokenFromQS) localStorage.setItem("FN_API_TOKEN", tokenFromQS);

        const API_URL_VOICELOG = "/api/voice-logs/";
        const API_URL_TTS      = "/api/tts/";

        const elText   = document.getElementById("vl-textarea");
        const elCount  = document.getElementById("charCount");
        const btnSave  = document.getElementById("btnSave");
        const btnClear = document.getElementById("btnClear");
        const btnTTS   = document.getElementById("btnSpeak");
        const tbody    = document.querySelector("#tblDrafts tbody");
        const btnSync  = document.getElementById("btnSync");
        const btnPurge = document.getElementById("btnPurge");
        const player   = document.getElementById("player");
        const netStatus= document.getElementById("netStatus");

        const MAX_TEXT_LEN=4000, MAX_KEEP=500;
        function isOnline(){ return navigator.onLine; }
        function updateNetBadge(){
          netStatus.textContent = isOnline() ? "ONLINE" : "OFFLINE";
          netStatus.className = `badge ${isOnline() ? "text-bg-success" : "text-bg-secondary"}`;
        }
        addEventListener("online",updateNetBadge);
        addEventListener("offline",updateNetBadge);
        updateNetBadge();

        function genLocalId(){ return `L${Date.now()}${Math.random().toString(36).slice(2,8)}`; }
        function loadDrafts(){ try{const raw=localStorage.getItem(LS_DRAFTS); const arr=raw?JSON.parse(raw):[]; return Array.isArray(arr)?arr:[]}catch{return[];} }
        function saveDrafts(arr){ localStorage.setItem(LS_DRAFTS, JSON.stringify(arr.slice(0,MAX_KEEP))); }
        function renderCharCount(){ const len=(elText.value||"").length; if(len>MAX_TEXT_LEN) elText.value=elText.value.slice(0,MAX_TEXT_LEN); elCount.textContent=String((elText.value||"").length); }
        elText.addEventListener("input",renderCharCount); renderCharCount();

        function showDetailsModal(text) {
          const backdrop = document.createElement('div'); backdrop.className = 'vl-modal-backdrop'; backdrop.tabIndex = -1;
          const modal = document.createElement('div');
          modal.className = 'vl-modal'; modal.setAttribute('role','dialog'); modal.setAttribute('aria-modal','true');
          modal.innerHTML = `
            <div class="vl-modal-header">
              <h5 class="vl-modal-title">下書き詳細</h5>
              <button class="vl-btn-close" aria-label="閉じる">✕</button>
            </div>
            <div class="vl-modal-body"><pre></pre></div>`;
          modal.querySelector('pre').textContent = text || "";
          const close = () => { document.removeEventListener('keydown', onKey); backdrop.remove(); document.body.style.overflow=''; };
          const onKey = (e) => { if (e.key === 'Escape') close(); };
          modal.querySelector('.vl-btn-close').addEventListener('click', close);
          backdrop.addEventListener('click', e => { if (e.target === backdrop) close(); });
          document.addEventListener('keydown', onKey);
          backdrop.appendChild(modal); document.body.appendChild(backdrop); document.body.style.overflow='hidden';
        }

        function renderTable(){
          const drafts=loadDrafts(); tbody.innerHTML="";
          if(drafts.length===0){
            tbody.innerHTML='<tr><td colspan="4" class="text-center text-muted">下書きはありません。</td></tr>';
            return;
          }
          for(const d of drafts){
            const tr=document.createElement("tr");
            tr.innerHTML=`
              <td class="col-id">${d.id}</td>
              <td class="col-text"></td>
              <td class="col-ts">${fmtJST.format(new Date(d.ts))}</td>
              <td class="col-ops">
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-sm btn-outline-info btn-details">詳細</button>
                  <button class="btn btn-sm btn-outline-danger btn-del">削除</button>
                </div>
              </td>`;
            tr.querySelector(".col-text").textContent=d.text;
            tr.querySelector(".btn-details").addEventListener("click",()=>showDetailsModal(d.text));
            tr.querySelector(".btn-del").addEventListener("click",()=>removeOne(d.id));
            tbody.appendChild(tr);
          }
        }

        function addLocalDraft(text){
          const arr=loadDrafts();
          arr.unshift({id:genLocalId(), text, ts:Date.now(), sent:false});
          saveDrafts(arr); renderTable();
        }
        function removeOne(id){
          if(!confirm("この下書きを削除しますか？")) return;
          saveDrafts(loadDrafts().filter(x=>x.id!==id)); renderTable();
        }

        // サーバ同期（必要な人だけ使えるよう残しています）
        async function postToServer(text){
          if(!API_TOKEN){ alertMsg("APIトークン未設定のため同期できません。"); throw new Error("no-token"); }
          const headers={
            "Authorization": `Bearer ${API_TOKEN}`,
            "Content-Type": "application/json; charset=utf-8",
            "Accept": "application/json"
          };
          const body=JSON.stringify({text, intent:"note"});
          const res=await fetch(API_URL_VOICELOG,{method:"POST", headers, body});
          if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          return (await res.json()).id;
        }
        async function syncAllPending(){
          if(!isOnline()){ alertMsg("現在オフラインです。オンライン復帰後に再実行してください。"); return; }
          const arr=loadDrafts(); let changed=false;
          for(const d of arr.filter(x=>!x.sent)){
            try{ await postToServer(d.text); d.sent=true; changed=true; }catch(e){ console.warn("同期失敗:",e); }
          }
          if(changed){ saveDrafts(arr); renderTable(); }
        }

        // TTS（保存時に再生できる音声を生成・セット）
        let currentObjectUrl=null;
        async function prepareTTS(text){
          text=(text||"").trim(); if(!text) return;
          try{
            const res = await fetch(API_URL_TTS,{
              method:"POST",
              headers:{
                "Authorization": API_TOKEN ? `Bearer ${API_TOKEN}` : "",
                "Content-Type":"application/json; charset=utf-8",
                "Accept":"audio/mpeg, audio/*;q=0.9, application/json;q=0.1"
              },
              body: JSON.stringify({ text })
            });
            const ctype=(res.headers.get("content-type")||"").toLowerCase();
            if(!res.ok || ctype.includes("application/json")) return;
            const blob=await res.blob(); if(!blob || blob.size===0) return;
            if(currentObjectUrl){ URL.revokeObjectURL(currentObjectUrl); currentObjectUrl=null; }
            currentObjectUrl=URL.createObjectURL(blob);
            player.pause(); player.src=currentObjectUrl; player.setAttribute("type","audio/mpeg"); player.load();
          }catch(e){ console.warn("TTSエラー:",e); }
        }

        async function onSaveClicked(){
          const text=(elText.value||"").trim(); if(!text){ alertMsg("テキストが空です"); return; }
          await prepareTTS(text);
          addLocalDraft(text); elText.value=""; renderCharCount();
        }

        // STT（長押し）
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let rec=null, isRecording=false, longPressed=false, pressTimer=null;
        function ensureSTT(){
          if(!SpeechRecognition){ alertMsg("このブラウザは音声入力に対応していません（Chrome 推奨）。"); return false; }
          if(!rec){
            rec = new SpeechRecognition();
            rec.lang="ja-JP"; rec.continuous=true; rec.interimResults=true; rec.maxAlternatives=1;
            const normalizeJa = (s)=>(s||"").replace(/\s+/g," ").replace(/(、){2,}/g,"、").replace(/(。){2,}/g,"。").trim();
            const smartAppend = (a,b)=>{ a=a||""; b=b||""; if(!b) return a; if(a.endsWith(b)) return a; const win=a.slice(-60); if(b.length>=6 && win.includes(b)) return a; const max=Math.min(50,a.length,b.length); for(let k=max;k>0;k--){ if(a.slice(-k)===b.slice(0,k)) return a+b.slice(k); } return a+b; };
            let lastFinalPiece=""; const almostSame=(x,y)=>{ if(!x||!y) return false; const n=Math.min(x.length,y.length); if(n<6) return false; let same=0; for(let i=0;i<n;i++) if(x[i]===y[i]) same++; return same/Math.max(x.length,y.length)>=0.8; };
            let finalBuf=""; let interimBuf="";
            rec.onstart=()=>{ finalBuf=elText.value||""; interimBuf=""; lastFinalPiece=""; };
            rec.onresult=(e)=>{
              for(let i=e.resultIndex;i<e.results.length;i++){
                const r=e.results[i]; const piece=normalizeJa((r[0]&&r[0].transcript)||"");
                if(r.isFinal){
                  if(!(finalBuf.endsWith(piece) || almostSame(piece,lastFinalPiece))){ finalBuf=smartAppend(finalBuf,piece); lastFinalPiece=piece; }
                  interimBuf="";
                }else{ interimBuf=piece; }
              }
              elText.value = normalizeJa(smartAppend(finalBuf, interimBuf)); renderCharCount();
            };
            rec.onerror=(e)=>{ console.error("SpeechRecognition Error:",e.error); alertMsg(`音声入力エラー: ${e.error}`); };
            rec.onend=()=>{ 
              elText.value=normalizeJa(finalBuf); isRecording=false; btnTTS.classList.remove('rec'); btnTTS.textContent='長押しでSTT（文字起こし）';
              renderCharCount(); prepareTTS(elText.value.trim());
            };
          }
          return true;
        }
        function sttStart(){ if(!ensureSTT()||isRecording) return; try{ rec.start(); isRecording=true; btnTTS.classList.add('rec'); btnTTS.textContent='録音中…（離すと確定）'; }catch(e){ console.error("STT開始エラー:",e); } }
        function sttStop(){ if(!rec||!isRecording) return; try{ rec.stop(); }catch(e){ console.error("STT停止エラー:",e); } }
        document.addEventListener("visibilitychange",()=>{ if(document.hidden) sttStop(); });
        window.addEventListener("beforeunload",()=>{ sttStop(); });

        if(btnTTS){
          const down=()=>{ longPressed=false; pressTimer=setTimeout(()=>{ longPressed=true; sttStart(); },600); };
          const up=()=>{ clearTimeout(pressTimer); if(longPressed){ sttStop(); } };
          const cancel=()=>{ clearTimeout(pressTimer); };
          btnTTS.addEventListener("mousedown",down); btnTTS.addEventListener("mouseup",up); btnTTS.addEventListener("mouseleave",cancel);
          btnTTS.addEventListener("touchstart",down,{passive:true}); btnTTS.addEventListener("touchend",up); btnTTS.addEventListener("touchcancel",cancel);
          btnTTS.addEventListener("contextmenu",e=>e.preventDefault());
        }

        btnClear.addEventListener("click",()=>{ elText.value=""; renderCharCount(); });
        btnSave.addEventListener("click",onSaveClicked);
        btnSync.addEventListener("click",syncAllPending);
        btnPurge.addEventListener("click",()=>{ if(!confirm("ローカル下書きを全て削除します。よろしいですか？")) return; localStorage.removeItem(LS_DRAFTS); renderTable(); });

        renderTable();
      })();
    </script>
  </main>

  <footer class="border-top py-4 mt-4">
    <div class="container d-flex justify-content-between small">
      <span>© FieldNote</span>
      <span>v2.5</span>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
