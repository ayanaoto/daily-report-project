{% extends "base.html" %}
{% load static %}
{% block title %}音声ログ{% endblock %}

{% block content %}
<div class="container my-4" style="max-width: 980px;">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="h4 mb-0">音声ログ</h1>
        <span class="badge text-bg-light" id="netStatus">ONLINE</span>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <label class="form-label" for="vl-textarea">メモ / 指示</label>
            <textarea id="vl-textarea" class="form-control" rows="4" placeholder="例）A社 10/3 15:00 訪問の件、資料は最新版v3で。"></textarea>
            <div class="d-flex align-items-center justify-content-between mt-2">
                <small class="text-secondary"><span id="charCount">0</span> 文字</small>
                <small class="text-secondary">長押し＝文字起こし（STT）</small>
            </div>
            <div class="mt-3 d-flex flex-wrap gap-2">
                <button id="btnSpeak" class="btn btn-primary">長押しでSTT（文字起こし）</button>
                <button id="btnSave" class="btn btn-success">保存（ログに追加）</button>
                <button id="btnClear" class="btn btn-outline-secondary">クリア</button>
            </div>
            <div class="mt-2 text-muted small">
                ※ 日報には各自でコピー＆ペーストしてください。
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>ローカル下書き</span>
            <div class="d-flex flex-wrap gap-2">
                <button id="btnSync" class="btn btn-sm btn-outline-secondary">未送信を同期</button>
                <button id="btnPurge" class="btn btn-sm btn-outline-danger">全削除</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped mb-0" id="tblDrafts">
                <thead>
                    <tr>
                        <th class="col-id">ローカルID</th>
                        <th class="col-text">テキスト</th>
                        <th class="col-ts">日時</th>
                        <th class="col-ops">操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<template id="details-modal-template">
    <div class="vl-modal-backdrop" tabindex="-1">
        <div class="vl-modal" role="dialog" aria-modal="true">
            <div class="vl-modal-header">
                <h5 class="vl-modal-title">下書き詳細</h5>
                <button class="vl-btn-close" aria-label="閉じる">✕</button>
            </div>
            <div class="vl-modal-body">
                <pre></pre>
            </div>
        </div>
    </div>
</template>

{% endblock %}


{% block extra_scripts %}
<script>
(() => {
    "use strict";

    const LS_DRAFTS = "vl_drafts";
    // ▼▼▼【ここが修正点】▼▼▼
    // `reports:` の名前空間を追加
    const API_URL_VOICELOG = "{% url 'reports:api_voice_logs' %}"; 
    const API_URL_TTS = "{% url 'reports:api_tts' %}";
    // ▲▲▲【ここまで】▲▲▲
    const API_TOKEN = "{{ api_token }}";

    const elText = document.getElementById("vl-textarea");
    const elCount = document.getElementById("charCount");
    const btnSave = document.getElementById("btnSave");
    const btnClear = document.getElementById("btnClear");
    const btnTTS = document.getElementById("btnSpeak");
    const tbody = document.querySelector("#tblDrafts tbody");
    const btnSync = document.getElementById("btnSync");
    const btnPurge = document.getElementById("btnPurge");
    const netStatus = document.getElementById("netStatus");
    const modalTemplate = document.getElementById("details-modal-template");

    const MAX_TEXT_LEN = 4000;
    const MAX_KEEP = 500;
    
    const alertMsg = (m) => window.alert(m);
    const fmtJST = new Intl.DateTimeFormat("ja-JP", { dateStyle: "medium", timeStyle: "medium", timeZone: "Asia/Tokyo" });
    const genLocalId = () => `L${Date.now()}${Math.random().toString(36).slice(2, 8)}`;
    const isOnline = () => navigator.onLine;

    function updateNetBadge() {
        netStatus.textContent = isOnline() ? "ONLINE" : "OFFLINE";
        netStatus.className = `badge ${isOnline() ? "text-bg-success" : "text-bg-secondary"}`;
    }
    window.addEventListener("online", updateNetBadge);
    window.addEventListener("offline", updateNetBadge);
    updateNetBadge();

    function renderCharCount() {
        const len = (elText.value || "").length;
        if (len > MAX_TEXT_LEN) {
            elText.value = elText.value.slice(0, MAX_TEXT_LEN);
        }
        elCount.textContent = String((elText.value || "").length);
    }
    elText.addEventListener("input", renderCharCount);
    renderCharCount();

    const loadDrafts = () => { try { const r = localStorage.getItem(LS_DRAFTS); return r ? JSON.parse(r) : []; } catch { return []; } };
    const saveDrafts = (arr) => localStorage.setItem(LS_DRAFTS, JSON.stringify(arr.slice(0, MAX_KEEP)));

    function renderTable() {
        const drafts = loadDrafts();
        tbody.innerHTML = "";
        if (drafts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">下書きはありません。</td></tr>';
            return;
        }
        for (const d of drafts) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="col-id">${d.id}</td>
                <td class="col-text"></td>
                <td class="col-ts">${fmtJST.format(new Date(d.ts))}</td>
                <td class="col-ops">
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-sm btn-outline-info btn-details">詳細</button>
                        <button class="btn btn-sm btn-outline-danger btn-del">削除</button>
                    </div>
                </td>`;
            tr.querySelector(".col-text").textContent = d.text;
            tr.querySelector(".btn-details").addEventListener("click", () => showDetailsModal(d.text));
            tr.querySelector(".btn-del").addEventListener("click", () => removeOne(d.id));
            tbody.appendChild(tr);
        }
    }
    
    function showDetailsModal(text) {
        const modalNode = modalTemplate.content.cloneNode(true);
        const backdrop = modalNode.querySelector('.vl-modal-backdrop');
        modalNode.querySelector('pre').textContent = text || "";
        
        const close = () => backdrop.remove();
        modalNode.querySelector('.vl-btn-close').addEventListener('click', close);
        backdrop.addEventListener('click', e => { if (e.target === backdrop) close(); });
        
        document.body.appendChild(modalNode);
    }

    function addLocalDraft(text) {
        const arr = loadDrafts();
        arr.unshift({ id: genLocalId(), text, ts: Date.now(), sent: false });
        saveDrafts(arr);
        renderTable();
    }
    function removeOne(id) {
        if (!confirm("この下書きを削除しますか？")) return;
        saveDrafts(loadDrafts().filter(x => x.id !== id));
        renderTable();
    }

    function onSaveClicked() {
        const text = (elText.value || "").trim();
        if (!text) {
            alertMsg("テキストが空です");
            return;
        }
        addLocalDraft(text);
        elText.value = "";
        renderCharCount();
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null, isRecording = false, longPressed = false, pressTimer = null;

    function ensureSTT() {
        if (!SpeechRecognition) {
            alertMsg("このブラウザは音声入力に対応していません（Chrome, Edgeを推奨）。");
            return false;
        }
        if (!rec) {
            rec = new SpeechRecognition();
            rec.lang = "ja-JP";
            rec.continuous = true;
            rec.interimResults = true;
            let finalTranscript = '';
            
            rec.onstart = () => {
                finalTranscript = elText.value;
                isRecording = true;
                btnTTS.classList.add('rec');
                btnTTS.textContent = '録音中…（離すと確定）';
            };
            
            rec.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                elText.value = finalTranscript + interimTranscript;
                renderCharCount();
            };

            rec.onerror = (event) => {
                console.error("SpeechRecognition Error:", event.error);
                alertMsg(`音声入力エラー: ${event.error}`);
            };

            rec.onend = () => {
                isRecording = false;
                btnTTS.classList.remove('rec');
                btnTTS.textContent = '長押しでSTT（文字起こし）';
                elText.value = finalTranscript;
                renderCharCount();
            };
        }
        return true;
    }
    
    function sttStart() {
        if (!ensureSTT() || isRecording) return;
        try { rec.start(); } catch (e) { console.error("STT開始エラー:", e); }
    }
    function sttStop() {
        if (!rec || !isRecording) return;
        try { rec.stop(); } catch (e) { console.error("STT停止エラー:", e); }
    }

    if (btnTTS) {
        const down = () => { longPressed = false; pressTimer = setTimeout(() => { longPressed = true; sttStart(); }, 600); };
        const up = () => { clearTimeout(pressTimer); if (longPressed) { sttStop(); } };
        btnTTS.addEventListener("mousedown", down);
        btnTTS.addEventListener("mouseup", up);
        btnTTS.addEventListener("mouseleave", up);
        btnTTS.addEventListener("touchstart", down, { passive: true });
        btnTTS.addEventListener("touchend", up);
        btnTTS.addEventListener("contextmenu", e => e.preventDefault());
    }

    btnClear.addEventListener("click", () => { elText.value = ""; renderCharCount(); });
    btnSave.addEventListener("click", onSaveClicked);
    btnPurge.addEventListener("click", () => {
        if (!confirm("ローカル下書きを全て削除します。よろしいですか？")) return;
        localStorage.removeItem(LS_DRAFTS);
        renderTable();
    });

    renderTable();
})();
</script>
{% endblock %}

{% block extra_styles %}
<style>
/* CSSは変更なし */
#tblDrafts{ table-layout:fixed; } #tblDrafts th,#tblDrafts td{ vertical-align:middle; }
#tblDrafts thead th{ position:sticky; top:0; background:#2a6078!important; color:#fff!important; z-index:1; }
#tblDrafts .col-id{ width:220px; } #tblDrafts .col-ts{ width:180px; white-space:nowrap; }
#tblDrafts .col-ops{ width:180px; white-space:nowrap; } #tblDrafts .col-text{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
@media (max-width:768px){ #tblDrafts thead{ display:none; } #tblDrafts tr,#tblDrafts td{ display:block; width:100%!important; border:0!important; }
    #tblDrafts tr{ border-top:2px solid #2a6078; padding:.5rem 0; margin-bottom:1rem; }
    #tblDrafts .col-text,#tblDrafts .col-ts{ display:none; }
}
#btnSpeak.rec{ position:relative; }
#btnSpeak.rec::after{ content:""; position:absolute; top:-6px; right:-6px; width:12px; height:12px; border-radius:9999px; background:#dc3545; box-shadow:0 0 0 6px rgba(220,53,69,.25); }
/* 詳細モーダル */
.vl-modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1050; display:flex; align-items:center; justify-content:center; padding:24px; }
.vl-modal{ width:min(960px,96vw); max-height:min(80vh,900px); display:flex; flex-direction:column; background:#fff; color:#111827; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden; }
.vl-modal-header{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #e5e7eb; background:#f8fafc; color:#0f172a; font-weight:600; }
.vl-modal-title{ margin:0; font-size:16px; }
.vl-btn-close{ appearance:none; border:0; background:transparent; cursor:pointer; width:28px; height:28px; border-radius:6px; color:#334155; }
.vl-btn-close:hover{ background:#e2e8f0; }
.vl-modal-body{ padding:16px; overflow:auto; }
.vl-modal-body pre{ margin:0; white-space:pre-wrap; word-break:break-word; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:14px; line-height:1.6; color:#111827; }
</style>
{% endblock %}