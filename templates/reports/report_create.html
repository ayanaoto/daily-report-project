{% extends 'base.html' %}

{% block title %}日報の投稿{% endblock %}

{% block content %}
    <h1>日報の投稿</h1>
    <form method="post" id="reportForm">
        {% csrf_token %}
        
        <div class="mb-3">
            <label for="{{ form.customer.id_for_label }}" class="form-label">{{ form.customer.label }}</label>
            {{ form.customer }}
        </div>
        
        <div class="mb-3">
            <label for="{{ form.deal.id_for_label }}" class="form-label">{{ form.deal.label }}</label>
            {{ form.deal }}
        </div>
        
        <div class="mb-3">
            <label for="{{ form.content.id_for_label }}" class="form-label">{{ form.content.label }}</label>
            <textarea name="{{ form.content.name }}" class="form-control" id="{{ form.content.id_for_label }}" rows="10" required></textarea>
        </div>
        
        <button type="submit" class="btn btn-success">投稿する</button>
        <a href="{% url 'report_list' %}" class="btn btn-secondary">一覧に戻る</a>
    </form>

    <script>
        // 顧客プルダウンのHTML要素を取得
        const customerSelect = document.getElementById('{{ form.customer.id_for_label }}');
        // 案件プルダウンのHTML要素を取得
        const dealSelect = document.getElementById('{{ form.deal.id_for_label }}');

        // 顧客プルダウンが変更された時に、以下の処理を実行する
        customerSelect.addEventListener('change', function() {
            const customerId = this.value; // 選択された顧客のIDを取得

            // 案件プルダウンの中身を一旦「---」だけにする
            dealSelect.innerHTML = '<option value="">---------</option>';

            if (customerId) {
                // DjangoのAPIに、選択された顧客IDを付けて問い合わせる
                fetch(`{% url 'ajax_load_deals' %}?customer_id=${customerId}`)
                    .then(response => response.json()) // 返ってきたデータをJSON形式に変換
                    .then(data => {
                        // 変換したデータを使って、案件プルダウンの中身を新しく作る
                        data.forEach(function(deal) {
                            const option = document.createElement('option');
                            option.value = deal.id;
                            option.textContent = deal.deal_name;
                            dealSelect.appendChild(option);
                        });
                    });
            }
        });
    </script>
{% endblock %}