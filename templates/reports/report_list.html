{% extends "base.html" %}

{% block title %}レポート一覧{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <h1 class="mb-4 fw-bold">レポート一覧</h1>

  <form method="get" class="row g-3 align-items-end mb-3">
    <div class="col-12 col-sm-6 col-md-3">
      <label for="start-date" class="form-label">開始日</label>
      <input type="date" name="start" id="start-date" value="{{ request.GET.start }}" class="form-control">
    </div>

    <div class="col-12 col-sm-6 col-md-3">
      <label for="end-date" class="form-label">終了日</label>
      <input type="date" name="end" id="end-date" value="{{ request.GET.end }}" class="form-control">
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label">キーワード</label>
      <input type="text" name="q" value="{{ request.GET.q }}" class="form-control" placeholder="顧客・件名・本文など">
    </div>

    <div class="col-6 col-md-1">
      <label class="form-label">並び順</label>
      <select name="sort" class="form-select">
        <option value="-created" {% if request.GET.sort == "-created" or not request.GET.sort %}selected{% endif %}>作成日が新しい順</option>
        <option value="created"  {% if request.GET.sort == "created" %}selected{% endif %}>作成日が古い順</option>
      </select>
    </div>

    <div class="col-6 col-md-1">
      <label class="form-label">件数</label>
      <select name="per_page" class="form-select">
        <option value="10" {% if request.GET.per_page == "10" or not request.GET.per_page %}selected{% endif %}>10</option>
        <option value="20" {% if request.GET.per_page == "20" %}selected{% endif %}>20</option>
        <option value="50" {% if request.GET.per_page == "50" %}selected{% endif %}>50</option>
      </select>
    </div>

    <div class="col-12 d-flex flex-wrap gap-2">
      <button class="btn btn-primary">絞り込み</button>
      <a class="btn btn-outline-secondary" href="{% url 'reports:report_list' %}">リセット</a>
      <a class="btn btn-outline-info" href="{% url 'reports:report_export_csv' %}?{{ request.GET.urlencode }}">CSV</a>
      
      <a class="btn btn-outline-dark" href="{% url 'reports:dashboard' %}">グラフ分析</a>
      
      <a class="btn btn-success ms-auto" href="{% url 'reports:report_create' %}">＋新規作成</a>
    </div>
  </form>

  {% if reports %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>作成日時</th>
            <th>タイトル / 本文</th>
            <th>報告者</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for r in reports %}
            <tr>
              <td>{{ r.created_at|date:"Y-m-d H:i" }}</td>
              <td>
                <div class="fw-semibold">
                  {{ r.title|default:"(無題)" }}
                  {% if r.location %}<span class="text-secondary ms-2">@ {{ r.location }}</span>{% endif %}
                </div>
                <div class="text-secondary small text-truncate" style="max-width: 70ch;">
                  {{ r.content|striptags }}
                </div>
              </td>
              <td>{{ r.author }}</td>
              <td class="text-end">
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'reports:report_detail' r.pk %}">詳細</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% else %}
    <div class="alert alert-info">該当するレポートがありません。</div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
  // ▼▼▼ 日付フィールドに今日のyyyy-mm-ddを初期値として設定するJavaScript ▼▼▼
  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0'); // 月は0から始まるので+1
    const dd = String(today.getDate()).padStart(2, '0');
    const todayString = `${yyyy}-${mm}-${dd}`;

    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');

    // URLに日付が指定されていない場合のみ、今日の日付をセット
    if (!startDateInput.value) {
      // 開始日は今月の1日をセット
      startDateInput.value = `${yyyy}-${mm}-01`;
    }
    if (!endDateInput.value) {
      endDateInput.value = todayString;
    }
  });
</script>
{% endblock %}