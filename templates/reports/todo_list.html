{% extends "base.html" %}
{% load static %}
{% block title %}ToDo一覧{% endblock %}

{% block content %}
<div class="container my-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">ToDo一覧</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-success" href="{% url 'reports:todo_create' %}">+ 新規作成</a>
      </div>
  </div>

  <form class="row g-3 align-items-end mb-3" method="get">
    <div class="col-12 col-md-6 col-lg-4">
      <label class="form-label small text-muted">キーワード</label>
      <input name="q" value="{{ request.GET.q }}" class="form-control" placeholder="件名・説明">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary" type="submit">絞り込み</button>
    </div>
    <div class="col-auto">
      <a class="btn btn-outline-secondary" href="{% url 'reports:todo_list' %}">リセット</a>
    </div>
    <div class="col-auto ms-auto d-flex gap-2">
      <button type="button" class="btn btn-outline-secondary" onclick="window.print()">印刷 / PDF</button>
    </div>
  </form>

  <form id="bulkForm" method="post" action="{% url 'reports:todo_delete_selected' %}">
    {% csrf_token %}
    <div id="printTodoArea" class="card">
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead class="table-dark">
            <tr>
              <th style="width: 48px;"></th>
              <th>件名 / 説明</th>
              <th style="width: 160px;">状態 / 作成</th>
              <th style="width: 120px;" class="text-end">操作</th>
            </tr>
          </thead>
          <tbody>
            {% for i in items %}
            <tr>
              <td>
                <input class="form-check-input todo-check" type="checkbox" name="todo_ids" value="{{ i.id }}">
              </td>
              <td>
                <div class="fw-semibold">
                  {% if i.is_done %}
                    <span class="badge text-bg-success me-2">Done</span>
                  {% else %}
                    <span class="badge text-bg-secondary me-2">Pending</span>
                  {% endif %}
                  {{ i.title }}
                  {% if i.deal %}<span class="small text-muted ms-2">（案件: {{ i.deal }}）</span>{% endif %}
                </div>
                {% if i.description %}
                <div class="small text-muted" style="white-space: pre-wrap;">{{ i.description }}</div>
                {% endif %}
              </td>
              <td>
                <div class="small text-muted">
                  {% if i.created_at %}{{ i.created_at|date:"Y-m-d H:i" }}{% else %}-{% endif %}
                </div>
              </td>
              <td class="text-end">
                <a class="btn btn-sm btn-outline-primary" href="{% url 'reports:todo_update' i.pk %}">編集</a>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="4">ToDoはありません。</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button type="submit" class="btn btn-outline-danger"
              onclick="return confirm('選択したToDoを削除します。よろしいですか？')">
        一括削除
      </button>
      <a class="btn btn-light" href="{% url 'reports:report_list' %}">日報一覧へ</a>
    </div>
  </form>

  <div class="text-muted small mt-2">
    PDF保存はブラウザの印刷から「PDFに保存」を選択してください。
  </div>
</div>
{% endblock %}

{% block extra_scripts %}{% endblock %}

{% block extra_styles %}
<style>
  @media print {
    .navbar, form, .btn, .dropdown, .alert, .breadcrumb { display: none !important; }
    .container { max-width: 100% !important; }
    .card { border: none !important; box-shadow: none !important; }
    .form-check-input { opacity: 0; }
    a[href]:after { content: ""; }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  }
</style>
{% endblock %}