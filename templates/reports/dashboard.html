{% extends "base.html" %}

{% block title %}グラフ分析ダッシュボード{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="h3 mb-4">グラフ分析ダッシュボード</h1>

  <div class="row mb-4">
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm h-100">
        <div class="card-body text-center">
          <h5 class="card-title">あなたの総作業件数</h5>
          <p class="card-text fs-2 fw-bold" id="user-total-count">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm h-100">
        <div class="card-body text-center">
          <h5 class="card-title">グループ全体の総作業件数</h5>
          <p class="card-text fs-2 fw-bold" id="group-total-count">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm h-100">
        <div class="card-body text-center">
          <h5 class="card-title">グループ全体の達成率</h5>
          <p class="card-text fs-2 fw-bold" id="achievement-rate">0 %</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header">あなたの進捗ステータス (件数)</div>
        <div class="card-body"><canvas id="personalProgressChart"></canvas></div>
      </div>
    </div>

    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header">あなたの場所ごと作業時間 (Top 10)</div>
        <div class="card-body"><canvas id="personalLocationHoursChart"></canvas></div>
      </div>
    </div>

    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header">グループ全体の進捗ステータス</div>
        <div class="card-body"><canvas id="groupProgressChart"></canvas></div>
      </div>
    </div>

    <div class="col-lg-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header">グループの担当者別作業件数</div>
        <div class="card-body"><canvas id="groupAuthorChart"></canvas></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const chartColors = ['#0d6efd', '#6f42c1', '#dc3545', '#fd7e14', '#198754', '#20c997', '#6c757d'];
  const charts = {}; // グラフインスタンスを保持

  // グラフ作成ヘルパー
  const makeChart = (ctxId, type, labels, data, label) => {
    const ctx = document.getElementById(ctxId);
    if (!ctx) return;
    if (charts[ctxId]) charts[ctxId].destroy(); // 既存のグラフを破棄
    charts[ctxId] = new Chart(ctx, {
      type: type,
      data: {
        labels: labels,
        datasets: [{ label: label, data: data, backgroundColor: chartColors }]
      },
      options: { responsive: true, maintainAspectRatio: false, indexAxis: type === 'bar' ? 'y' : 'x' }
    });
  };

  async function loadDashboardData() {
    try {
      const response = await fetch("{% url 'reports:dashboard_data' %}");
      if (!response.ok) throw new Error('Network response was not ok');
      const data = await response.json();

      // カードの数値を更新
      document.getElementById('user-total-count').textContent = data.cards.user_total_count;
      document.getElementById('group-total-count').textContent = data.cards.group_total_count;
      document.getElementById('achievement-rate').textContent = `${data.cards.achievement_rate} %`;

      // グラフを描画
      // 1. あなたの進捗
      const personalProgress = data.charts.personal_progress;
      if (personalProgress.length > 0) {
        makeChart('personalProgressChart', 'doughnut', personalProgress.map(d => d.progress), personalProgress.map(d => d.count), '件数');
      }
      
      // 2.【修正】あなたの場所ごと作業時間
      const personalLocHours = data.charts.personal_location_hours;
      if (Object.keys(personalLocHours).length > 0) {
        makeChart('personalLocationHoursChart', 'bar', Object.keys(personalLocHours), Object.values(personalLocHours), '合計作業時間 (h)');
      }

      // 3. グループ全体の進捗
      const groupProgress = data.charts.group_progress;
      if (groupProgress.length > 0) {
        makeChart('groupProgressChart', 'pie', groupProgress.map(d => d.progress), groupProgress.map(d => d.count), '件数');
      }

      // 4. グループの担当者別件数
      const groupAuthor = data.charts.group_author_count;
      if (groupAuthor.length > 0) {
        makeChart('groupAuthorChart', 'bar', groupAuthor.map(d => d.author__username), groupAuthor.map(d => d.count), '作業件数');
      }
      
    } catch (error) {
      console.error('Failed to load dashboard data:', error);
    }
  }

  loadDashboardData();
});
</script>
{% endblock %}